description = 'Tuweni distribution.'

apply plugin: 'distribution'

jar { enabled = false }

if (System.getenv('ENABLE_SIGNING') == 'true') {
  signing {
    useGpgCmd()
    sign distZip
    sign distTar
  }
}

distributions {
  main {
    baseName = 'tuweni-bin'
    contents {
      into('') {
        from ".."
        include 'README.md'
        include 'DISCLAIMER'
        include 'LICENSE'
        include 'NOTICE'
      }
      def docs = []
      def libs = []
      def sources = []
      rootProject.subprojects.each { s ->
        if (s.name != 'eth-reference-tests' && s.name != 'dist') {
          libs << s.signArchives.signatureFiles[0]
          sources << s.signArchives.signatureFiles[1]
          docs << s.signArchives.signatureFiles[2]
          libs << s.jar.outputs
          sources << s.sourcesJar.outputs
          docs << s.dokkaJar.outputs
        }
      }
      into('lib') {
        from rootProject.jar
        from rootProject.signArchives.signatureFiles[0]
        from libs
      }
      into('docs') {
        from rootProject.dokkaJar
        from rootProject.signArchives.signatureFiles[2]
        from docs
      }
      into('site') {
        from rootProject.dokka.outputDirectory
        from rootProject.javadoc.outputDirectory
      }
    }
  }
  sources {
    baseName = 'tuweni-src'
    contents {
      from rootProject.projectDir
      include 'LICENCE', '*.md', 'NOTICE', '*.gradle', 'DISCLAIMER', 'gradle/**', 'gradlew', 'gradle.properties'
      rootProject.subprojects.each {
        include it.projectDir.name + '/src/**'
        include it.projectDir.name + '/build.gradle'
      }
    }
  }
}

import org.gradle.crypto.checksum.Checksum

distTar{ compression = Compression.GZIP }


sourcesDistTar{ compression = Compression.GZIP }

task createChecksums(type: Checksum, dependsOn: [
  'distZip',
  'distTar',
  'sourcesDistZip',
  'sourcesDistTar'
]) {
  files = distZip.outputs.files + distTar.outputs.files + sourcesDistZip.outputs.files + sourcesDistTar.outputs.files
  outputDir = new File(project.buildDir, "distributions")
  algorithm = Checksum.Algorithm.SHA512
}

build.dependsOn('createChecksums')
